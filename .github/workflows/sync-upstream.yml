name: Sync with Upstream and Report

on:
  schedule:
    - cron: '0 0 */3 * *'  # æ¯3å¤©è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºä»“åº“
      - name: Checkout your repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}
          ref: master  # ä½ çš„åˆ†æ”¯
          fetch-depth: 0  # è·å–æ‰€æœ‰å†å²è®°å½•ï¼Œä»¥ä¾¿æ¯”è¾ƒ

      # å®‰è£… GitHub CLI (gh)
      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install gh

      # é…ç½® Git ç”¨æˆ·
      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # æ·»åŠ ä¸Šæ¸¸è¿œç¨‹ä»“åº“
      - name: Add upstream remote
        run: git remote add upstream https://github.com/wukongdaily/store.git

      # è·å–ä¸Šæ¸¸ä»“åº“æ›´æ–°
      - name: Fetch upstream
        run: git fetch upstream

      # æ¸…ç†7å¤©å‰çš„å·¥ä½œæµè®°å½•
      - name: Clean up workflows older than 7 days
        env:
          GH_TOKEN: ${{ secrets.PAT }}  # ä½¿ç”¨ä½ åœ¨ Repository secrets ä¸­å­˜å‚¨çš„ PAT token
        run: |
          # æ‰“å°å½“å‰æ—¶é—´ï¼Œç”¨äºè°ƒè¯•
          echo "Current date: $(date)"

          # è®¾ç½®æ—¶é—´ä¸º7å¤©å‰çš„æ—¥æœŸ
          SEVEN_DAYS_AGO=$(date -d "7 days ago" --utc +%Y-%m-%dT%H:%M:%SZ)
          echo "7 days ago date: $SEVEN_DAYS_AGO"

          # ä½¿ç”¨ GitHub CLI è·å–å·¥ä½œæµåˆ—è¡¨ï¼Œç­›é€‰å‡º7å¤©å‰çš„å·¥ä½œæµ
          WORKFLOWS=$(gh run list --limit 100 --json createdAt,databaseId --jq ".[] | select(.createdAt < \"$SEVEN_DAYS_AGO\") | .databaseId")

          # æ‰“å°æŸ¥è¯¢åˆ°çš„å·¥ä½œæµ IDï¼Œè¿›è¡Œè°ƒè¯•
          echo "Found workflows to delete: $WORKFLOWS"

          # åˆ é™¤æŸ¥è¯¢åˆ°çš„å·¥ä½œæµ
          for WF in $WORKFLOWS; do
            echo "Deleting workflow with ID: $WF"
            gh run delete $WF --confirm
          done

      # æ£€æŸ¥ä¸Šæ¸¸æ˜¯å¦æœ‰æ–°çš„æäº¤
      - name: Check for new commits
        id: check_diff
        run: |
          COMMIT_COUNT=$(git rev-list --count master..upstream/master)
          if [ "$COMMIT_COUNT" -gt 0 ]; then
            echo "has_new_commits=true" >> $GITHUB_ENV
            echo "commit_count=$COMMIT_COUNT" >> $GITHUB_ENV
            echo "New commits found: $COMMIT_COUNT"
          else
            echo "has_new_commits=false" >> $GITHUB_ENV
            echo "No new commits from upstream. Nothing to do."
          fi

      # æ¨¡æ‹Ÿåˆå¹¶ä»¥æ£€æµ‹å†²çª (ä»…åœ¨æœ‰æ–°æäº¤æ—¶è¿è¡Œ)
      - name: Detect conflicts (dry run)
        if: env.has_new_commits == 'true'
        id: detect_conflicts
        run: |
          git merge upstream/master --no-commit --no-ff || true
          CONFLICTED_FILES=$(git status --porcelain | grep "^UU" | awk '{print $2}')
          if [ -n "$CONFLICTED_FILES" ]; then
            echo "conflict_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CONFLICTED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "conflict_files=none" >> $GITHUB_OUTPUT
          fi
          git merge --abort

      # è®°å½•å°†è¦åˆå¹¶çš„ä¸Šæ¸¸æäº¤ä¿¡æ¯ (ä»…åœ¨æœ‰æ–°æäº¤æ—¶è¿è¡Œ)
      - name: Get upstream commit log
        if: env.has_new_commits == 'true'
        id: get_log
        run: |
          LOG_MESSAGE=$(git log --pretty=format:'* %h - %s (%an)' master..upstream/master)
          echo "log_message<<EOF" >> $GITHUB_OUTPUT
          echo "$LOG_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # æ­£å¼åˆå¹¶ä¸æ¨é€ (ä»…åœ¨æœ‰æ–°æäº¤æ—¶è¿è¡Œ)
      - name: Merge and Push
        if: env.has_new_commits == 'true'
        run: |
          git merge -X theirs upstream/master --allow-unrelated-histories -m "chore: auto-sync from wukongdaily/store"
          git push origin master

      # åˆ›å»ºæŠ¥å‘Šå¹¶å‘å¸ƒä¸º Issue (ä»…åœ¨æœ‰æ–°æäº¤æ—¶è¿è¡Œ)
      - name: Create Sync Report Issue
        if: env.has_new_commits == 'true'
        uses: peter-evans/create-issue-from-file@v5
        with:
          token: ${{ secrets.PAT }}
          title: "ğŸ¤– ä¸Šæ¸¸åŒæ­¥æŠ¥å‘Š (wukongdaily/store)"
          content-filepath: ./sync-report.md
          labels: "automated-sync"

      # å‡†å¤‡æŠ¥å‘Šæ–‡ä»¶å†…å®¹ (ä»…åœ¨æœ‰æ–°æäº¤æ—¶è¿è¡Œ)
      - name: Prepare Report Content
        if: env.has_new_commits == 'true'
        run: |
          echo "### è‡ªåŠ¨åŒæ­¥å®Œæˆ âœ…" > ./sync-report.md
          echo "" >> ./sync-report.md
          echo "**${{ env.commit_count }}** ä¸ªæ–°æäº¤å·²ä» \`wukongdaily/store\` åŒæ­¥è‡³ä½ çš„ä»“åº“ã€‚" >> ./sync-report.md
          echo "" >> ./sync-report.md
          echo "---" >> ./sync-report.md
          echo "" >> ./sync-report.md
          echo "#### è¯¦ç»†æäº¤è®°å½•ï¼š" >> ./sync-report.md
          echo "\`\`\`" >> ./sync-report.md
          echo "${{ steps.get_log.outputs.log_message }}" >> ./sync-report.md
          echo "\`\`\`" >> ./sync-report.md
          echo "" >> ./sync-report.md
          
          if [ "${{ steps.detect_conflicts.outputs.conflict_files }}" != "none" ]; then
            echo "### âš ï¸ å†²çªè­¦å‘Š" >> ./sync-report.md
            echo "ä»¥ä¸‹æ–‡ä»¶å‘ç”Ÿäº†å†²çªï¼Œå¹¶å·²è‡ªåŠ¨é‡‡ç”¨ **ä¸Šæ¸¸ç‰ˆæœ¬** è¦†ç›–äº†ä½ çš„ä¿®æ”¹ï¼š" >> ./sync-report.md
            echo "\`\`\`" >> ./sync-report.md
            echo "${{ steps.detect_conflicts.outputs.conflict_files }}" >> ./sync-report.md
            echo "\`\`\`" >> ./sync-report.md
            echo "> **è¯·æ³¨æ„**: ä½ åœ¨è¿™äº›æ–‡ä»¶ä¸­çš„æœ¬åœ°ä¿®æ”¹å¯èƒ½å·²ç»ä¸¢å¤±ï¼Œè¯·æ£€æŸ¥ç¡®è®¤ã€‚" >> ./sync-report.md
          else
            echo "### âœ… æ— å†²çª" >> ./sync-report.md
            echo "æ‰€æœ‰ä¸Šæ¸¸æ›´æ–°å·²é¡ºåˆ©åˆå¹¶ï¼Œæœªæ£€æµ‹åˆ°ä¸ä½ çš„ä¿®æ”¹æœ‰å†²çªã€‚" >> ./sync-report.md
          fi
