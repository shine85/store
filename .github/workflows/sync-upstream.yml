# 工作流名称
name: Sync with Upstream (wukongdaily/store)

on:
  # 1. 定时触发：每小时的第0分钟执行一次。
  schedule:
    - cron: '0 * * * *'
  
  # 2. 手动触发：允许你在 Actions 页面手动运行
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 第 1 步：检出你自己的仓库代码
      # 使用你配置的 PAT，这样后续才有权限推送
      - name: Checkout your repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}
          ref: master  # <-- 修改点 1：确保检出的是 master 分支

      # 第 2 步：配置 Git 用户信息
      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # 第 3 步：添加上游仓库作为远程源
      - name: Add upstream remote
        run: git remote add upstream https://github.com/wukongdaily/store.git

      # 第 4 步：从上游仓库拉取最新内容
      - name: Fetch from upstream
        run: git fetch upstream

      # 第 5 步：合并上游的 master 分支到你的 master 分支
      - name: Merge upstream/master into your master
        run: |
          # 使用 -X theirs 策略：
          # - 如果没有冲突，正常合并。
          # - 如果存在冲突，自动采用上游（theirs）的版本来解决冲突。
          # - --allow-unrelated-histories 避免因历史不相关导致合并失败。
          git merge -X theirs upstream/master --allow-unrelated-histories -m "chore: auto-sync from wukongdaily/store"
          
      # 第 6 步：将合并后的内容推送到你的仓库
      - name: Push changes to your repository
        run: git push origin master
